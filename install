#!/bin/sh
# zsh4humans安装脚本

# 如果在zsh中运行，设置适当的选项
if '[' '-n' "${ZSH_VERSION-}" ']'; then
  'emulate' 'sh' '-o' 'err_exit' '-o' 'no_unset'  # 模拟sh行为，启用错误退出和变量必须设置
else
  'set' '-ue'  # 在其他shell中启用错误退出和变量必须设置
fi

# 获取系统平台信息
platform="$('command' 'uname' '-sm')"  # 获取系统名称和架构
platform="$('printf' '%s' "$platform" | 'command' 'tr' '[A-Z]' '[a-z]')"  # 转换为小写

# 检查平台是否支持
case "$platform" in
  'darwin arm64');;  # Apple Silicon Mac
  'darwin x86_64');;  # Intel Mac
  'linux aarch64');;  # ARM 64位Linux
  'linux armv6l');;  # ARM v6 Linux (如Raspberry Pi早期版本)
  'linux armv7l');;  # ARM v7 Linux (如Raspberry Pi 2)
  'linux armv8l');;  # ARM v8 Linux
  'linux x86_64');;  # x86_64 Linux
  'linux i686');;  # x86 32位Linux
  *)
    # 不支持的平台，显示错误并退出
    >&2 'printf' '\033[33mz4h\033[0m: sorry, unsupported platform: \033[31m%s\033[0m\n' "$platform"
    'exit' '1'
  ;;
esac

# 检查是否安装了curl或wget，用于下载文件
if command -v 'curl' >'/dev/null' 2>&1; then
  fetch='command curl -fsSLo'  # 使用curl下载文件
elif command -v 'wget' >'/dev/null' 2>&1; then
  fetch='command wget -O'  # 使用wget下载文件
else
  # 两者都没有安装，显示错误并退出
  >&2 'printf' '\033[33mz4h\033[0m: please install \033[32mcurl\033[0m or \033[32mwget\033[0m\n'
  'exit' '1'
fi

# 检查HOME环境变量是否指向一个目录
if '[' '!' '-d' "${HOME-}" ']'; then
  >&2 'printf' '\033[33mz4h\033[0m: \033[1m$HOME\033[0m is not a directory\n'
  'exit' '1'
fi

# 检查是否以root用户运行
euid="$('command' 'id' '-u')"
if '[' "$euid" '=' '0' ']'; then
  # 获取HOME目录的所有者
  home_ls="$('command' 'ls' '-ld' '--' "$HOME")"
  home_owner="$('printf' '%s\n' "$home_ls" | 'command' 'awk' 'NR==1 {print $3}')"
  # 如果HOME目录不属于root，则不应该使用sudo运行
  if '[' "$home_owner" '!=' 'root' ']'; then
    >&2 'printf' '\033[33mz4h\033[0m: please retry without \033[4;32msudo\033[0m\n'
    'exit' '1'
  fi
fi

# 检查标准输入是否为终端
if '[' '!' '-t' '0' ']'; then
  >&2 'printf' '\033[33mz4h\033[0m: standard input is not a \033[1mTTY\033[0m\n'
  'exit' '1'
fi

# 检查标准输出是否为终端
if '[' '!' '-t' '1' ']'; then
  >&2 'printf' '\033[33mz4h\033[0m: standard output is not a \033[1mTTY\033[0m\n'
  'exit' '1'
fi

# 检查标准错误是否为终端
if '[' '!' '-t' '2' ']'; then
  >&2 'printf' '\033[33mz4h\033[0m: standard error is not a \033[1mTTY\033[0m\n'
  'exit' '1'
fi

# 保存当前终端设置，以便后续恢复
saved_tty_settings="$('command' 'stty' '-g')"

# 初始化临时文件变量
zshenv=''  # 临时.zshenv文件路径
zshrc=''   # 临时.zshrc文件路径
z4h=''     # 临时z4h.zsh文件路径

# 清理函数，用于在脚本退出时执行
cleanup() {
  'trap' '-' 'INT' 'TERM' 'EXIT'  # 移除信号处理器
  'command' 'rm' '-f' '--' "$zshenv" "$zshrc" "${zshrc:+$zshrc.bak}" "$z4h"  # 删除临时文件
  'command' 'stty' "$saved_tty_settings"  # 恢复终端设置
}

# 设置信号处理器，在脚本中断、终止或退出时调用cleanup函数
'trap' 'cleanup' 'INT' 'TERM' 'EXIT'

# 定义换行符变量，用于后续的输入处理
lf='
'

# 读取用户输入的函数
read_choice() {
  choice=''
  # 设置终端为非规范模式，每次读取一个字符
  'command' 'stty' '-icanon' 'min' '1' 'time' '0'
  while :; do
    # 读取一个字符
    c="$('command' 'dd' 'bs=1' 'count=1' 2>'/dev/null' && 'echo' 'x')"
    # 添加到选择字符串中
    choice="$choice${c%x}"
    # 计算选择字符串的长度
    n="$('printf' '%s' "$choice" | 'command' 'wc' '-m')"
    # 如果长度不为0，则跳出循环
    '[' "$n" '-eq' '0' ']' || 'break'
  done
  # 恢复终端设置
  'command' 'stty' "$saved_tty_settings"
  # 如果选择不是换行符，则输出一个换行
  '[' "$choice" '=' "$lf" ] || 'echo'
}

>&2 'printf' 'Greetings, Human!\n'
>&2 'printf' '\n'
>&2 'printf' 'What kind of \033[1mkeyboard\033[0m are you using?\n'
>&2 'printf' '\n'
>&2 'printf' '  \033[1m(1)\033[0m  Mac. It has \033[32mOption\033[0m key(s) and does not have \033[33mAlt\033[0m.\n'
>&2 'printf' '  \033[1m(2)\033[0m  PC.  It has \033[32mAlt\033[0m key(s) and does not have \033[33mOption\033[0m.\n'
>&2 'printf' '  \033[1m(q)\033[0m  Quit and do nothing.\n'
>&2 'printf' '\n'
while 'true'; do
  >&2 'printf' '\033[1mChoice [12q]:\033[0m '
  'read_choice'
  case "$choice" in
    '1')
      bs_key='Delete'
      zshrc_suffix='.mac'
      'break'
    ;;
    '2')
      bs_key='Backspace'
      zshrc_suffix=''
      'break'
    ;;
    'q'|'Q')
      'exit' '1'
    ;;
    "$lf")
    ;;
    *)
      >&2 'printf' '\033[33mz4h\033[0m: invalid choice: \033[31m%s\033[0m\n' "$choice"
    ;;
  esac
done

>&2 'printf' '\n'
>&2 'printf' 'What \033[1mkeybindings\033[0m do you prefer?\n'
>&2 'printf' '\n'
>&2 'printf' '  \033[1m(1)\033[0m  Standard. I delete characters with \033[33m%s\033[0m key.\n' "$bs_key"
>&2 'printf' '  \033[1m(2)\033[0m  Like in \033[32mvi\033[0m. I delete characters with \033[33mX\033[0m key in \033[33mcommand mode\033[0m.\n'
>&2 'printf' '  \033[1m(q)\033[0m  Quit and do nothing.\n'
>&2 'printf' '\n'
while 'true'; do
  >&2 'printf' '\033[1mChoice [12q]:\033[0m '
  'read_choice'
  case "$choice" in
    '1')
      'break'
    ;;
    '2')
      >&2 'printf' '\n'
      >&2 'printf' 'Sorry, \033[32mvi\033[0m keybindings are \033[31mnot supported\033[0m yet.\n'
      'exit' '1'
      'break'
    ;;
    'q'|'Q')
      'exit' '1'
    ;;
    "$lf")
    ;;
    *)
      >&2 'printf' '\033[33mz4h\033[0m: invalid choice: \033[31m%s\033[0m\n' "$choice"
    ;;
  esac
done

>&2 'printf' '\n'
>&2 'printf' 'Do you want \033[32mzsh\033[0m to always run in \033[32mtmux\033[0m?\n'
>&2 'printf' '\n'
>&2 'printf' '  \033[1m(y)\033[0m  Yes.\n'
>&2 'printf' '  \033[1m(n)\033[0m  No.\n'
>&2 'printf' '  \033[1m(q)\033[0m  Quit and do nothing.\n'
>&2 'printf' '\n'
while 'true'; do
  >&2 'printf' '\033[1mChoice [ynq]:\033[0m '
  'read_choice'
  case "$choice" in
    'y'|'Y')
      tmux='1'
      'break'
    ;;
    'n'|'N')
      tmux='0'
      'break'
    ;;
    'q'|'Q')
      'exit' '1'
    ;;
    "$lf")
    ;;
    *)
      >&2 'printf' '\033[33mz4h\033[0m: invalid choice: \033[31m%s\033[0m\n' "$choice"
    ;;
  esac
done

>&2 'printf' '\n'
>&2 'printf' 'Do you use \033[32mdirenv\033[0m?\n'
>&2 'printf' '\n'
>&2 'printf' '  \033[1m(y)\033[0m  Yes.\n'
>&2 'printf' '  \033[1m(n)\033[0m  No.\n'
>&2 'printf' '  \033[1m(q)\033[0m  Quit and do nothing.\n'
>&2 'printf' '\n'
while 'true'; do
  >&2 'printf' '\033[1mChoice [ynq]:\033[0m '
  'read_choice'
  case "$choice" in
    'y'|'Y')
      direnv='1'
      'break'
    ;;
    'n'|'N')
      direnv='0'
      'break'
    ;;
    'q'|'Q')
      'exit' '1'
    ;;
    "$lf")
    ;;
    *)
      >&2 'printf' '\033[33mz4h\033[0m: invalid choice: \033[31m%s\033[0m\n' "$choice"
    ;;
  esac
done

rcs=''

for f in ~/'.zshenv' ~/'.zshenv.zwc'     \
         ~/'.zprofile' ~/'.zprofile.zwc' \
         ~/'.zshrc' ~/'.zshrc.zwc'       \
         ~/'.zlogin' ~/'.zlogin.zwc'     \
         ~/'.zlogout' ~/'.zlogout.zwc'; do
  if '[' '-e' "$f" ']'; then
    rcs="$rcs ${f##*/}"
  fi
done

backup_dir=''

if '[' '-n' "$rcs" ']'; then
  backup_dir='zsh-backup'
  if command -v 'date' >'/dev/null' 2>&1; then
    backup_dir="$backup_dir/$('command' 'date' '+%Y%m%d-%H%M%S')"
  fi
  if [ '-e' "$HOME/$backup_dir" ]; then
    i='1'
    while '[' '-e' "$HOME/$backup_dir.$i" ]; do
      i="$((i+1))"
    done
    backup_dir="$backup_dir.$i"
  fi
  >&2 'printf' '\n'
  >&2 'printf' 'You have the following Zsh \033[1mstartup files\033[0m:\n'
  >&2 'printf' '\n'
  for f in $rcs; do
    >&2 'printf' '    \033[4m~/%s\033[0m\n' "$f"
  done
  >&2 'printf' '\n'
  >&2 'printf' 'What should I do with them?\n'
  >&2 'printf' '\n'
  >&2 'printf' '  \033[1m(1)\033[0m  Move them to \033[4m~/%s\033[0m. \033[1mRecommended\033[0m.\n' "$backup_dir"
  >&2 'printf' '  \033[1m(2)\033[0m  Delete them.\n'
  >&2 'printf' '  \033[1m(q)\033[0m  Quit and do nothing.\n'
  >&2 'printf' '\n'
  while 'true'; do
    >&2 'printf' '\033[1mChoice [12q]:\033[0m '
    'read_choice'
    case "$choice" in
      '1')
        backup_dir="$HOME/$backup_dir"
        'break'
      ;;
      '2')
        backup_dir=''
        'break'
      ;;
      'q'|'Q')
        'exit' '1'
      ;;
      "$lf")
      ;;
      *)
        >&2 'printf' '\033[33mz4h\033[0m: invalid choice: \033[31m%s\033[0m\n' "$choice"
      ;;
    esac
  done
  >&2 'printf' '\n'
fi

if command -v 'mktemp' >'/dev/null' 2>&1; then
  zshenv="$('command' 'mktemp' "$HOME"/.zshenv.XXXXXXXXXX)"
  zshrc="$('command' 'mktemp' "$HOME"/.zshrc.XXXXXXXXXX)"
  z4h="$('command' 'mktemp' "$HOME"/.z4h.XXXXXXXXXX)"
else
  zshenv="$HOME"/.zshenv.tmp."$$"
  zshrc="$HOME"/.zshrc.tmp."$$"
  z4h="$HOME"/.z4h.tmp."$$"
fi

url='https://raw.githubusercontent.com/romkatv/zsh4humans/v5'

>&2 'printf' '\n'
>&2 'printf' 'Settings up \033[33mZsh For Humans\033[0m...\n'
>&2 'printf' '\n'

>&2 printf '\033[33mz4h\033[0m: fetching \033[4mz4h.zsh\033[0m from \033[1mgithub.com/romkatv/zsh4humans\033[0m\n'
if ! err="$($fetch "$z4h" '--' "$url"/z4h.zsh 2>&1)"; then
  >&2 'printf' "%s\n" "$err"
  >&2 'printf' '\033[33mz4h\033[0m: failed to download \033[31m%s\033[0m\n' "$url"/z4h.zsh
  'command' 'rm' '-rf' '--' "$Z4H" 2>'/dev/null'
  'exit' '1'
fi

>&2 'printf' '\033[33mz4h\033[0m: generating \033[4m~/.zshenv\033[0m\n'
if ! err="$($fetch "$zshenv" '--' "$url"/.zshenv 2>&1)"; then
  >&2 'printf' "%s\n" "$err"
  >&2 'printf' '\033[33mz4h\033[0m: failed to download \033[31m%s\033[0m\n' "$url"/.zshenv
  'exit' '1'
fi

>&2 'printf' '\033[33mz4h\033[0m: generating \033[4m~/.zshrc\033[0m\n'
if ! err="$($fetch "$zshrc" '--' "$url"/.zshrc"$zshrc_suffix" 2>&1)"; then
  >&2 'printf' "%s\n" "$err"
  >&2 'printf' '\033[33mz4h\033[0m: failed to download \033[31m%s\033[0m\n' "$url"/.zshrc"$zshrc_suffix"
  'exit' '1'
fi

if '[' "$tmux" '=' '1' ']'; then
  'command' 'awk' "/Mark up shell's output/ {print \"# Start tmux if not already in tmux.\"; print \"zstyle ':z4h:' start-tmux command tmux -u new -A -D -t z4h\"; print \"\"; print \"# Whether to move prompt to the bottom when zsh starts and on Ctrl+L.\"; print \"zstyle ':z4h:' prompt-at-bottom 'no'\"; print \"\"} 1" "$zshrc" >"$zshrc.bak"
else
  'command' 'awk' "/Mark up shell's output/ {print \"# Don't start tmux.\"; print \"zstyle ':z4h:' start-tmux       no\"; print \"\"} 1" "$zshrc" >"$zshrc.bak"
fi
'command' 'mv' '--' "$zshrc.bak" "$zshrc"

if '[' "$direnv" '=' '1' ']'; then
  'command' 'sed' '-i.bak' '-E' "/direnv.*enable/ s/'no'/'yes'/" "$zshrc"
  'command' 'rm' '-f' '--' "$zshrc".bak
fi

if '[' '-r' '/proc/version' ']' && 'command' 'grep' '-q' '[Mm]icrosoft' '/proc/version' 2>'/dev/null'; then
  'command' 'awk' "/Clone additional Git repositories from GitHub/ {print \"# Start ssh-agent if it's not running yet.\"; print \"zstyle ':z4h:ssh-agent:' start yes\"; print \"\"} 1" "$zshrc" >"$zshrc.bak"
  'command' 'mv' '--' "$zshrc.bak" "$zshrc"
fi

Z4H="${XDG_CACHE_HOME:-$HOME/.cache}/zsh4humans/v5"

'umask' 'o-w'

'command' 'rm' '-rf' '--' "$Z4H"
'command' 'mkdir' '-p' -- "$Z4H"

if '[' '-n' "$backup_dir" ']'; then
  'command' 'mkdir' '-p' '--' "$backup_dir"
  ('cd' && 'command' 'cp' '-p' '--' $rcs "$backup_dir"/) || 'exit'
fi

if '[' '-n' "$rcs" ']'; then
  ('cd' && 'command' 'rm' '-f' '--' $rcs ) || 'exit'
fi

'command' 'mv' '--' "$zshenv" ~/'.zshenv'
'command' 'mv' '--' "$zshrc" ~/'.zshrc'
'command' 'mv' '--' "$z4h" "$Z4H"/z4h.zsh

'printf' '%s\n' "$backup_dir" >"$Z4H"/welcome

'cleanup'

>&2 'printf' '\033[33mz4h\033[0m: bootstrapping \033[32mzsh\033[0m environment\n'

'export' ZDOTDIR="$HOME"
Z4H_BOOTSTRAPPING='1'
'set' '+ue'
'set' '--'
'.' ~/'.zshenv'
